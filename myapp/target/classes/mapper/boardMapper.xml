<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="board">

	<select id="listCriteria" resultType="com.devseok0414.myapp.model.dto.BoardDTO">
		SELECT * FROM board ORDER BY ref DESC, re_step ASC
	</select>
	
	<select id="listCountCriteria" resultType="_int">
		SELECT count(*) FROM board
	</select>
	
	<select id="searchListCriteria" resultType="com.devseok0414.myapp.model.dto.BoardDTO">
		SELECT * FROM board WHERE ${searchSelect} Like '%'||#{searchText}||'%' ORDER BY ref DESC, re_step ASC
	</select>
	
	<select id="searchListCountCriteria" resultType="_int">
		SELECT count(*) FROM board WHERE ${searchSelect} Like '%'||#{searchText}||'%'
	</select>
	
	<select id="boardListView" resultType="com.devseok0414.myapp.model.dto.BoardDTO">
		SELECT * FROM board WHERE no = #{no}
	</select>
	
	<insert id="saveWrite">
		INSERT INTO board (no, member_id, subject, content, password, reg_date, ref, re_step, re_level)
		VALUES (seq_board.nextval, #{memberId}, #{subject}, #{content}, #{password}, default, seq_board.nextval, default, default)
	</insert>
	
	<select id="authView" resultType="string">
		SELECT password FROM board where no = #{no}
	</select>

	<select id="selectRef" resultType="_int">
		<![CDATA[
			SELECT NVL(MIN(re_step),0) FROM board
			WHERE ref = #{ref}
			AND re_step > #{reStep}
			AND re_level <= #{reLevel}
		]]>
	</select>	
	
	<select id="calcReStep" resultType="_int">
		SELECT NVL(MAX(re_step),0) + 1 AS re_step FROM board WHERE ref = #{ref}
	</select>
	
	<insert id="saveReply">
		INSERT INTO board (no, member_id, subject, content, password, reg_date, ref, re_step, re_level)
		VALUES (seq_board.nextval, #{memberId}, #{subject}, #{content}, #{password}, default, #{ref}, #{reStep}, #{reLevel})
	</insert>
	
	<update id="modifyReStep">
		<![CDATA[
		UPDATE board SET re_step = re_step + 1
		WHERE ref = #{ref} AND re_step >= #{reStep}
		]]>
	</update>
	
	<delete id="removeBoard">
		DELETE FROM board WHERE no = #{no}
	</delete>
	
	<update id="modifyBoard">
		UPDATE board SET subject = #{subject}, content = #{content} WHERE no = #{no} 
	</update>
	
</mapper>